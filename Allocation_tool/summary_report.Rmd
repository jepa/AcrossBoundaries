---
title: "Across boundaries quota allocation tool report"
date: "`r format(Sys.time(), '%d %B, %Y')`"
author: "This report was generated by `r input$UserName`"
output: 
  pdf_document:
    toc: yes
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = F)

library(ggplot2)
library(MyFunctions)
```

*`r input$SppSelection`* 

```{r stock_image, fig.width=5, fig.height=4}

if(input$SppSelection == "Centropristis striata"){
  
  source <- 'https://media.fisheries.noaa.gov/styles/original/s3/dam-migration/640x427-black-sea-bass.png?itok=7Ax8suz_'
  common_name <-  "Black sea bass"
}

if(input$SppSelection == "Stenotomus chrysops"){
  
  source= 'https://media.fisheries.noaa.gov/styles/original/s3/dam-migration/scup.png?itok=noMUoDe0'
  common_name <- "Scupt"
}

if(input$SppSelection == "Paralichthys dentatus"){
  
  source  <-  'https://media.fisheries.noaa.gov/styles/original/s3/2021-03/640x427-summer-flounder.png?itok=B6G4jkW7'
  common_name <- "Summer flounder"
}

  img <- png::readPNG(RCurl::getURLContent(source))
grid::grid.raster(img)

```

- **Stock:** *`r input$SppSelection`* (`r common_name`)

- **Survey** `r input$SurveySelection`

- **Regulatory unit approach**: `r input$SpatSelection`

- **Year range for distribution** `r min(input$YearSelection)` to `r max(input$YearSelection)` 

\clearpage

# Introduction

The following report is a product of your selections in the [Across Boundary app](www.link.com) on "`r format(Sys.time(), '%d %B, %Y')`". Specifically, you made the following selections:

- **Stock:** *`r input$SppSelection`* (`r common_name`)

- **Survey** `r input$SurveySelection`

- **Regulatory unit approach**: `r input$SpatSelection`

- **Year range for distribution** `r min(input$YearSelection)` to `r max(input$YearSelection)` 

# Results


## Number of grids per regulatory area

```{r}

if(input$SpatSelection == "State waters"){
  n_grids <- grids %>%
    filter(spatial == "sw") %>% 
    group_by(state) %>% 
    summarise(Grids = length(unique(index))) %>% 
    arrange(Grids)
}

if(input$SpatSelection == "Fishing ports"){
  n_grids <- grids %>%
    filter(spatial == "fp") %>% 
    group_by(state) %>% 
    summarise(Grids = length(unique(index))) %>% 
    arrange(Grids)
  
}

if(input$SpatSelection == "Both apporaches"){
  
  n_grids <-
    grids %>%
    group_by(state,spatial) %>% 
    summarise(Grids = length(unique(index)),
              Ports = length(unique(landing_port))
    ) %>% 
    gather("Category","type",Grids,Ports) %>% 
    spread(spatial,type) %>% 
    filter(Category == "Grids") %>% 
    arrange(Category,state) %>% 
    mutate(
      Difference = abs(replace_na(fp,0) - sw)
    ) %>% 
    left_join(state_order) %>% 
    select(State = state,
           "Fishing ports" = fp,
           "State waters" = sw,
           Difference) %>% 
    arrange(desc(Difference))
  
}

knitr::kable(n_grids)

```

## Graph

```{r grid_fig, fig.width=10, fig.height=10}

if(input$SpatSelection == "State waters"){
                
                gridExtra::grid.arrange(
                    # Overall (overlapping) position
                    ggplot(grid_eez_sw_sf) +
                        geom_sf(aes(color =group , fill = group), alpha = 0.3) +
                        geom_sf(data = subset(us_map,ID %in% c("maine", "new hampshire", "massachusetts", "connecticut",
                                                               "rhode island", "new york", "new jersey", "delaware", "maryland",
                                                               "virginia", "north carolina"))
                        ) +
                        scale_color_manual(values = state_pallet) +
                        scale_fill_manual(values = state_pallet) +
                        my_ggtheme_p(leg_pos = "",
                                     ax_tx_s = 13) +
                        coord_sf(ylim = c(30,48)) +
                        scale_y_continuous(breaks = c(30,35,40,45))+
                        labs(x = "", y = "", title = "") +
                        theme(plot.title = element_text(size = 20)),
                    # Showing each state separately
                    ggplot(grid_eez_sw_sf) +
                        geom_sf(data = subset(us_map,ID %in% c("maine", "new hampshire", "massachusetts", "connecticut",
                                                               "rhode island", "new york", "new jersey", "delaware", "maryland",
                                                               "virginia", "north carolina"))
                        ) +
                        geom_sf(aes(color = group),size = 0.1, alpha = 0.3) +
                        facet_wrap(~ group) +
                        theme(legend.position = "top") +
                        scale_color_manual(values = state_pallet,
                                           labels = grid_eez_sw_sf %>% arrange(order) %>%  pull(state) %>% unique()) +
                        ggtitle("") +
                        my_ggtheme_p(leg_pos = "",
                                     ax_tx_s = 11,
                                     axx_tx_ang = 45,
                                     hjust = 1
                        ),
                    nrow = 1)
                
            }
                # ---------------------------- #
                # Fishing Ports ######
                # ---------------------------- #
                if(input$SpatSelection == "Fishing ports"){
                    
                    gridExtra::grid.arrange(
                        # Overall (overlapping) position
                        ggplot(grid_eez_fp_sf) +
                            geom_sf(aes(color =group , fill = group), alpha = 0.3) +
                            geom_sf(data = subset(us_map,ID %in% c("maine", "new hampshire", "massachusetts", "connecticut",
                                                                   "rhode island", "new york", "new jersey", "delaware", "maryland",
                                                                   "virginia", "north carolina"))
                            ) +
                            scale_color_manual(values = state_pallet) +
                            scale_fill_manual(values = state_pallet) +
                            my_ggtheme_p(leg_pos = "",
                                         ax_tx_s = 13) +
                            coord_sf(ylim = c(30,48)) +
                            scale_y_continuous(breaks = c(30,35,40,45))+
                            labs(x = "", y = "", title = "") +
                            theme(plot.title = element_text(size = 20)),
                        # Showing each state separately
                        ggplot(grid_eez_fp_sf) +
                            geom_sf(data = subset(us_map,ID %in% c("maine", "new hampshire", "massachusetts", "connecticut",
                                                                   "rhode island", "new york", "new jersey", "delaware", "maryland",
                                                                   "virginia", "north carolina"))
                            ) +
                            geom_sf(aes(color = group),size = 0.1, alpha = 0.3) +
                            facet_wrap(~ group) +
                            theme(legend.position = "top") +
                            scale_color_manual(values = state_pallet,
                                               labels = grid_eez_fp_sf %>% arrange(order) %>%  pull(state) %>% unique()) +
                            ggtitle("") +
                            my_ggtheme_p(leg_pos = "",
                                         ax_tx_s = 11,
                                         axx_tx_ang = 45,
                                         hjust = 1
                            ),
                        nrow = 1)
                    
                    
                }
                    # ---------------------------- #
                    # Both maps ######
                    # ---------------------------- #
                    if(input$SpatSelection == "Both apporaches"){
                        
                        sw_map <- gridExtra::grid.arrange(
                            # Overall (overlapping) position
                            ggplot(grid_eez_sw_sf) +
                                geom_sf(aes(color =group , fill = group), alpha = 0.3) +
                                geom_sf(data = subset(us_map,ID %in% c("maine", "new hampshire", "massachusetts", "connecticut",
                                                                       "rhode island", "new york", "new jersey", "delaware", "maryland",
                                                                       "virginia", "north carolina"))
                                ) +
                                scale_color_manual(values = state_pallet) +
                                scale_fill_manual(values = state_pallet) +
                                my_ggtheme_p(leg_pos = "",
                                             ax_tx_s = 13) +
                                coord_sf(ylim = c(30,48)) +
                                scale_y_continuous(breaks = c(30,35,40,45))+
                                labs(x = "", y = "", title = "State waters approach") +
                                theme(plot.title = element_text(size = 20)),
                            # Showing each state separately
                            ggplot(grid_eez_sw_sf) +
                                geom_sf(data = subset(us_map,ID %in% c("maine", "new hampshire", "massachusetts", "connecticut",
                                                                       "rhode island", "new york", "new jersey", "delaware", "maryland",
                                                                       "virginia", "north carolina"))
                                ) +
                                geom_sf(aes(color = group),size = 0.1, alpha = 0.3) +
                                facet_wrap(~ group) +
                                theme(legend.position = "top") +
                                scale_color_manual(values = state_pallet,
                                                   labels = grid_eez_sw_sf %>% arrange(order) %>%  pull(state) %>% unique()) +
                                ggtitle("") +
                                my_ggtheme_m(map_type = "global", leg_pos = ""),
                            nrow = 1)
                        
                        fp_map <- gridExtra::grid.arrange(
                            # Overall (overlapping) position
                            ggplot(grid_eez_fp_sf) +
                                geom_sf(aes(color =group , fill = group), alpha = 0.3) +
                                geom_sf(data = subset(us_map,ID %in% c("maine", "new hampshire", "massachusetts", "connecticut",
                                                                       "rhode island", "new york", "new jersey", "delaware", "maryland",
                                                                       "virginia", "north carolina"))
                                ) +
                                scale_color_manual(values = state_pallet) +
                                scale_fill_manual(values = state_pallet) +
                                my_ggtheme_p(leg_pos = "",
                                             ax_tx_s = 13) +
                                coord_sf(ylim = c(30,48)) +
                                scale_y_continuous(breaks = c(30,35,40,45))+
                                labs(x = "", y = "", title = "Fishing ports approach") +
                                theme(plot.title = element_text(size = 20)),
                            # Showing each state separately
                            ggplot(grid_eez_fp_sf) +
                                geom_sf(data = subset(us_map,ID %in% c("maine", "new hampshire", "massachusetts", "connecticut",
                                                                       "rhode island", "new york", "new jersey", "delaware", "maryland",
                                                                       "virginia", "north carolina"))
                                ) +
                                geom_sf(aes(color = group),size = 0.1, alpha = 0.3) +
                                facet_wrap(~ group) +
                                theme(legend.position = "top") +
                                scale_color_manual(values = state_pallet,
                                                   labels = grid_eez_fp_sf %>% arrange(order) %>%  pull(state) %>% unique()) +
                                ggtitle("") +
                                my_ggtheme_m(map_type = "global", leg_pos = ""),
                            nrow = 1)
                        
                        # Show plots
                        gridExtra::grid.arrange(sw_map,fp_map,
                                                bottom = "Longitude",
                                                left = "Latitude")
                    }
                
```



# Acknowkedgments 

Some type of acknowledgmentes... Data was generated from... Paper link... etc... 

