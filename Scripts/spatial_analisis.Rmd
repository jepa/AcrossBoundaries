---
title: "Spatial Analysis"
output: html_notebook
---

```{r setup, include=FALSE}
MyFunctions::my_lib(c("ggmap","sf","tidyverse","tools","readr","data.table","maps"))
```


# Load data

## Ocean adapt data

- Using only "Northeast US Fall and Spring surveys for now

```{r dat_exploded, eval = T, echo = F}

ocean_data <- readRDS("/Volumes/Enterprise/Data/pinskylab-OceanAdapt-966adf0/data_clean/dat_exploded.rds") %>% 
  filter(spp == "Centropristis striata",
       region %in% c("Northeast US Fall" , "Northeast US Spring")) #No more seasons


```

## Maps data

```{r maps_sf, eval = T, echo = T, results = 'hide'}

States <- c("maine", "new hampshire", "massachusets", "connecticut", "rhode island", "new york", "new jersey", "delaware", "maryland", "virginia", "north carolina") 

# US State Map (land)

land_sf <- st_as_sf(map("state", plot = FALSE, fill = TRUE)) %>% 
  filter(ID %in% States) 

# ggplot(us_map) +
  # geom_sf()

# US EEZ map

# path_world <- MyFunctions::my_path("G", extra_path = "Spatial/SAU/SAU_Shapefile")
path_world <- "~/Downloads/SAU_Shapefile"

# The File
fnam_world <- "SAUEEZ_July2015.shp"

# Load it!
eez_sf <- st_read(dsn = path_world,
                        layer =file_path_sans_ext(fnam_world)) %>% 
  rename(eez_name = Name) %>% 
  st_transform(crs = 4326) %>% # 4326
  st_simplify(preserveTopology = TRUE, dTolerance = 10000) %>% #0.1 for paper
  filter(eez_name == "USA (East Coast)")


# ggplot(eez_sf) +
# geom_sf(aes(),fill =NA)

# ggplot() +
#   geom_sf(data = World_eez_sf, aes(), color = "red") +
#   geom_sf(data = us_map, aes(), color = "blue")



# US state waters
# https://catalog.data.gov/dataset/federal-and-state-waters

# us_state_w <- rgdal::readOGR(dsn = "~/Downloads/FederalAndStateWaters/FederalAndStateWaters.gdb")
state_sf <-  st_read("~/Downloads/FederalAndStateWaters/FederalAndStateWaters.gdb") %>% 
  janitor::clean_names() %>% 
  mutate(jurisdicti = str_to_lower(jurisdicti)) %>% 
  filter(jurisdicti %in% States) %>% 
  rename(state = jurisdicti)
  # st_transform(crs = 4326)  # for matching projections
  # st_simplify(preserveTopology = TRUE, dTolerance = 0.1)

```

### 1. Expand Spatial regions (a.k.a  buffers)

A buffer of *410000* m (410 KM / 221) overshoots the EEZ a bit, but is eventually cropped

```{r buffer, eval = T, echo = T}

# Buffer state waters
state_bf = st_buffer(state_sf, 410000) %>% 
  st_transform(4326) %>% # to match shape
  st_set_crs(4326)

# ------------------------------ #
# Testing and visualizing the buffer 
# ------------------------------ #

state_bf_plot <- ggplot() +
  geom_sf(data = eez_sf, aes(), fill = NA) +
  geom_sf(data = state_bf, aes(color = state), fill = NA)
#   

# ggsave("../Results/Partial/state_waters_buffer.png",state_bf_plot)

# ------------------------------ #

state_bf_plot

```

### 2. Expand grid within buffer

Here we expand a grid within the buffer so we can estimate the catch within

```{r grid_indexing, eval = T, echo = T, message = F, warning = F}

# Create grid of the region
bbox <- c(st_bbox(state_bf))

# Expand the grid
ne_grid <- expand.grid(
    lon = seq(from = bbox["xmin"], to = bbox["xmax"], by = 0.3),
    lat = seq(from = bbox["ymin"], to = bbox["ymax"], by = 0.3)
) %>% 
  rowid_to_column("index")

# ----------- #
# [TEST] Plot all layers
# ----------- #

# Looks good
state_sf %>%
  st_transform(4326) %>% # to match shape
  st_set_crs(4326) %>%
  st_simplify(preserveTopology = TRUE, dTolerance = 10000) %>%
  ggplot() +
  geom_sf(aes(color = state))+
  # geom_sf(data = eez_sf, aes(),fill =NA) +
  # ggplot()+
  geom_tile(data = ne_grid,
            aes(
              x = lon,
              y = lat
            ),
            alpha = 0.2
  ) 


```

#### 2.1 Merge grid and buffers

Here we converted the grid to `sf`, merged with the buffered states and filter out everything outside the states polygon

```{r grid_buf_merge, eval = T, echo = T, message = F, warning = F, fig.width = 10}

# ---------------- #
# Convert grid to sf
# ---------------- #
grid_sf <- st_as_sf(ne_grid,
             coords = c("lon", "lat"),
             crs = 4326) %>% 
  st_join(state_bf) %>% 
  filter(!is.na(state))

# Create data frame for future computations
# Note, will be used in next chunk
grid_bf_dt <- as.data.frame(grid_sf) %>%
    select(index,state)
    # group_by(state) %>% 
    # summarise(length(index))


# ---------------- #
# [TEST] 
# Visualization of grid
# ---------------- #

gridExtra::grid.arrange(
  # Overall (overlapping) position
  ggplot(grid_sf) +
    geom_sf(aes(color = state)) +
    geom_sf(data = eez_sf, aes(),fill =NA) + 
    theme(legend.position = ""),
  # Showing each state separatley
  ggplot() +
    geom_sf(data = grid_sf, aes(color = state),size = 0.1) +
    facet_wrap(~state) +
    theme(legend.position = "top"),
  nrow = 1)

```

### 3. Crop buffers to EEZ

```{r buff_to_eez, eval = T, echo = T, message = F, warning = F}


# I don't know how to undo st_simplify so need to re-load the shapefile
eez_sf <- st_read(dsn = path_world,
                        layer =file_path_sans_ext(fnam_world)) %>% 
  rename(eez_name = Name) %>% 
  st_transform(crs = 4326) %>% # 4326
  filter(eez_name == "USA (East Coast)")

# Get the overlapping segments
grid_eez_sf <- st_intersection(grid_sf,eez_sf)

# Get final df with index
grid_eez_df <- as.data.frame(grid_eez_sf) %>%
  select(state,index)

# Plot to make sure makes sense (Picasso syle)
grid_eez_sf %>% 
  st_simplify(preserveTopology = TRUE, dTolerance = 10000) %>% #0.1 for paper
  ggplot() +
  geom_sf(aes(color = state))


```


### Map of smapling points

In this case the color gradient represents wtcpue (wet tones catch per unit of effort, haul hours) from 1972 to 2019. Grey dots represent `wtcpue = 0`

```{r survey_map, eval = T, echo = T, fig.width = 12, fig.height = 8}

ggplot(us_map) +
  geom_sf() +
  geom_sf(data = World_eez_sf, aes(), fill = "white") +
  geom_point(data = subset(ocean_data, wtcpue = 0),
             aes(
               x = lon,
               y = lat
             ),
             color = "grey95",
             size = 1
  ) +
  geom_point(data = subset(ocean_data, wtcpue > 0),
             aes(
               x = lon,
               y = lat,
               color = log10(wtcpue)
             ),
             size = 1
  ) +
  scale_color_distiller(palette = "Spectral", 
                       guide_legend(title = "WCPUE per Haul (log10)")) + 
  coord_sf(xlim = c(-76, -65),ylim = c(35, 45)) +
  MyFunctions::my_ggtheme_m() +
  facet_wrap(~region)

```


# Interpolation

## SF example A

https://swilke-geoscience.net/post/spatial_interpolation/


```{r interpolation, eval = T, echo = T}

subset_data <- ocean_data %>% 
  filter(region == "Northeast US Spring",
         wtcpue > 0) %>% 
  group_by(lon,lat) %>% 
  summarise(wtcpue = sum(wtcpue,na.rm = T))


# First let's define a bounding Box to extrapolate from
bbox <- c(
  "xmin" = min(subset_data$lon),
  "ymin" = min(subset_data$lat),
  "xmax" = max(subset_data$lon),
  "ymax" = max(subset_data$lat)
)

# Expand the grid
grd_template <- expand.grid(
  lon = seq(from = bbox["xmin"], to = bbox["xmax"], by = 0.5),
  lat = seq(from = bbox["ymin"], to = bbox["ymax"], by = 0.5)
)


# ---------------- #
# Visualize the box


# ggplot() +
#   geom_point(data = grd_template, aes(x = lon, y = lat), size = 0.1) +
#   geom_point(data = subset_data,
#   mapping = aes(x = lon, y = lat, color = wtcpue), size = 3) +
#   scale_color_gradientn(colors = c("blue", "yellow", "red")) +
#   theme_bw()

# ---------------- #


# Rasterize our grid
# expects a PROJ.4 string, see https://epsg.io/25833

crs_raster_format <- "+proj=longlat +datum=WGS84 +no_defs"

grd_template_raster <- grd_template %>% 
  dplyr::mutate(Z = 0) %>% 
  raster::rasterFromXYZ( 
    crs = crs_raster_format)

# The model

# Triangular Irregular Surface
fit_tin <- interp::interp( # using {interp}
  x = subset_data$lon,           # the function actually accepts coordinate vectors
  y = subset_data$lat,
  z = subset_data$wtcpue,
  xo = grd_template$lon,     # here we already define the target grid
  yo = grd_template$lat,
  output = "points"
) %>% 
  bind_cols() %>% 
  filter(!is.na(z))

ggplot(us_map) +
  geom_sf()+
  geom_sf(data = World_eez_sf, aes(), fill = "white")+
  geom_tile( data = fit_tin,
             aes(
               x = x,
               y = y,
               fill =z,
               colour = z
             )
  ) +
  geom_point(data = subset(subset_data, wtcpue > 0),
             aes(
               x = lon,
               y = lat
             ),
             alpha = 0.2
  ) +
  scale_color_distiller(palette = "Spectral", 
                        guide_legend(title = "WCPUE per Haul")) + 
  scale_fill_distiller(palette = "Spectral", 
                       guide_legend(title = "WCPUE per Haul")) +
  coord_sf(xlim = c(-76, -65),ylim = c(35, 45)) +
  MyFunctions::my_ggtheme_m()


```


